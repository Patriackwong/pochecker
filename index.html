<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PO - ‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-green: #2e7d32; --bg-mint: #e8f5e9; --text-dark: #37474f;
            --white: #ffffff; --btn-blue: #1565c0; --btn-purple: #6a1b9a; --btn-sheet: #0f9d58;
            --status-success: #c8e6c9; --text-success: #2e7d32;
            --status-warning: #fff9c4; --text-warning: #f9a825;
            --status-error: #ffcdd2; --text-error: #c62828;
        }

        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-mint); color: var(--text-dark); margin: 0; padding-top: 80px; display: flex; justify-content: center; }
        
        /* --- Top Bar (‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏ô‡∏Ç‡∏ß‡∏≤) --- */
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: rgba(255,255,255,0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; justify-content: flex-end; align-items: center;
            padding: 0 20px; gap: 10px; z-index: 1000;
        }
        
        .top-btn {
            padding: 8px 16px; border-radius: 20px; border: none; color: white; cursor: pointer;
            font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 5px;
            text-decoration: none; transition: transform 0.2s;
        }
        .top-btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        
        .btn-chv { background-color: var(--btn-blue); }
        .btn-mrc { background-color: var(--btn-purple); }
        .btn-sheet { background-color: var(--btn-sheet); }
        .btn-logout { background-color: #eee; color: #333; border: 1px solid #ddd; }

        .container { background: var(--white); padding: 30px; border-radius: 16px; width: 90%; max-width: 1000px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        /* Inputs & Main Buttons */
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Sarabun'; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-excel { background: #f57c00; margin-top: 20px; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; }

        /* Results Layout */
        .result-cols { display: flex; gap: 15px; margin-top: 20px; text-align: left; }
        .col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .col-head { padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; }
        
        .bg-success { background: var(--status-success); color: var(--text-success); border: 1px solid #a5d6a7; }
        .bg-warning { background: var(--status-warning); color: var(--text-warning); border: 1px solid #fff59d; }
        .bg-error { background: var(--status-error); color: var(--text-error); border: 1px solid #ef9a9a; }

        .card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .card.success { border-left: 4px solid var(--text-success); }
        .card.warning { border-left: 4px solid var(--text-warning); }
        .card.error { border-left: 4px solid var(--text-error); }
        
        .row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .label { font-weight: bold; color: #555; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; color: white; }
        .badge.s { background: var(--text-success); }
        .badge.w { background: var(--text-warning); }
        .badge.e { background: var(--text-error); }

        .hidden { display: none !important; }
        #status-mini { font-size: 13px; font-weight: bold; color: #333; }
        
        @media(max-width: 800px) { .result-cols { flex-direction: column; } .top-bar { justify-content: center; flex-wrap: wrap; height: auto; padding: 10px; } }
    </style>
</head>
<body>

    <div id="top-bar" class="top-bar hidden">
        <span id="status-mini"></span>
        
        <input type="file" id="f-chv" hidden accept=".csv,.xlsx,.xls" onchange="uploadFile('CHV')">
        <input type="file" id="f-mrc" hidden accept=".csv,.xlsx,.xls" onchange="uploadFile('MRC')">

        <button id="btn-chv" class="top-btn btn-chv hidden" onclick="document.getElementById('f-chv').click()">‚òÅÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Chevron</button>
        <button id="btn-mrc" class="top-btn btn-mrc hidden" onclick="document.getElementById('f-mrc').click()">‚òÅÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Miracle</button>
        <a id="btn-sheet" href="#" target="_blank" class="top-btn btn-sheet hidden">üìä ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Sheet</a>
        
        <button class="top-btn btn-logout" onclick="location.reload()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="container">
        <div id="login-box">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</h2>
            <input type="password" id="code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button class="btn-main" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p id="msg" style="color:red; margin-top:10px;"></p>
        </div>

        <div id="app-box" class="hidden">
            <h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PO</h2>
            <textarea id="po" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç PO (‡πÅ‡∏¢‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)"></textarea>
            <button class="btn-main" onclick="doSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            <div id="result"></div>
            <button id="btn-dl" class="btn-excel hidden" onclick="dlExcel()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
        </div>
    </div>

    <script>
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxAwYe-jaOmWFtwzWNAFkjH4kGjOyB95tSIu8eY98i_9lmj18O4govpQdsFULy9QC8fYw/exec'; // üü¢ ‡πÉ‡∏™‡πà URL Apps Script
        const SHEET_LINK = 'https://docs.google.com/spreadsheets/d/1n5Nrr9Rf0-WQu2YIwc-0iFiaJENGZIVp_VzyaUt6-7c/edit?gid=2143202623#gid=2143202623'; // üü¢ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheet
        // ==========================================

        document.getElementById('btn-sheet').href = SHEET_LINK;
        let exportData = [], exportHead = [];

        // --- Login ---
        async function doLogin() {
            const code = document.getElementById('code').value.trim();
            const btn = document.querySelector('#login-box button');
            if(!code) return;
            
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
            try {
                const res = await fetch(`${API_URL}?action=login&code=${encodeURIComponent(code)}`);
                const json = await res.json(); // ‡∏≠‡πà‡∏≤‡∏ô JSON ‡∏ï‡∏£‡∏á‡πÜ

                if (json.status === 'success') {
                    // *** ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ: ‡∏≠‡πà‡∏≤‡∏ô role ‡∏ï‡∏£‡∏á‡πÜ ‡∏à‡∏≤‡∏Å json ***
                    const role = json.role || "user"; 
                    
                    document.getElementById('login-box').classList.add('hidden');
                    document.getElementById('app-box').classList.remove('hidden');
                    document.getElementById('top-bar').classList.remove('hidden');

                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°
                    if (role === 'admin') {
                        document.getElementById('btn-chv').classList.remove('hidden');
                        document.getElementById('btn-mrc').classList.remove('hidden');
                        document.getElementById('btn-sheet').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('msg').innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î";
                }
            } catch(e) {
                document.getElementById('msg').innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
            } finally {
                btn.disabled = false; btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            }
        }

        // --- Upload ---
        function uploadFile(type) {
            const file = document.getElementById(type==='CHV'?'f-chv':'f-mrc').files[0];
            if(!file) return;
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${type}?`)) return;

            const reader = new FileReader();
            const status = document.getElementById('status-mini');
            status.innerText = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...`; status.style.color="blue";

            reader.onload = async (e) => {
                let csv = "";
                if(file.name.endsWith('.csv')) csv = e.target.result;
                else {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    csv = XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]);
                }
                
                status.innerText = `üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...`;
                try {
                    const res = await fetch(API_URL, {
                        method:'POST', redirect:'follow',
                        headers:{'Content-Type':'text/plain;charset=utf-8'},
                        body: JSON.stringify({type:type, csvData:csv})
                    });
                    const json = await res.json();
                    if(json.status==='success') {
                        status.innerText = "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"; status.style.color="green";
                        alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    } else throw new Error(json.message);
                } catch(err) {
                    status.innerText = "‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"; status.style.color="red";
                    alert(err.message);
                }
            };
            
            if(file.name.endsWith('.csv')) reader.readAsText(file);
            else reader.readAsArrayBuffer(file);
        }

        // --- Search ---
        async function doSearch() {
            const po = document.getElementById('po').value;
            if(!po) return;
            document.getElementById('result').innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
            
            try {
                const res = await fetch(`${API_URL}?action=search&po=${encodeURIComponent(po)}`);
                const json = await res.json();
                
                if(json.status === 'success') {
                    exportData = json.data; exportHead = json.headers;
                    document.getElementById('btn-dl').classList.remove('hidden');
                    render(json.data, json.headers);
                } else {
                    document.getElementById('result').innerHTML = "<p style='color:red'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
                }
            } catch(e) { document.getElementById('result').innerText = "Error"; }
        }

        function render(data, heads) {
            let htmlS="", htmlW="", htmlE="", cS=0, cW=0, cE=0;
            data.forEach(r => {
                let txt = r.join(" ");
                let type = "success";
                if(txt.includes("‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")||txt.includes("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà")||txt.includes("‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô")||txt.includes("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")) type="error";
                else if(txt.includes("‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢")||txt.includes("‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á")) type="warning";

                let card = `<div class='card ${type}'><h3>PO: ${r[0]}</h3>`;
                r.forEach((v,i) => {
                    let val = v;
                    if(String(v).includes("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")) val = `<span class='badge s'>${v}</span>`;
                    if(String(v).includes("‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á")) val = `<span class='badge w'>${v}</span>`;
                    if(String(v).includes("‡πÑ‡∏°‡πà")) val = `<span class='badge e'>${v}</span>`;
                    card += `<div class='row'><span class='label'>${heads[i]||'Col'+i}:</span><span>${val}</span></div>`;
                });
                card += "</div>";

                if(type==="success") { htmlS+=card; cS++; }
                else if(type==="warning") { htmlW+=card; cW++; }
                else { htmlE+=card; cE++; }
            });

            document.getElementById('result').innerHTML = `
                <div class='result-cols'>
                    <div class='col'><div class='col-head bg-success'>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${cS})</div>${htmlS}</div>
                    <div class='col'><div class='col-head bg-warning'>üöö ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á (${cW})</div>${htmlW}</div>
                    <div class='col'><div class='col-head bg-error'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${cE})</div>${htmlE}</div>
                </div>`;
        }

        function dlExcel() {
            if(!exportData.length) return;
            let csv = "\uFEFF" + exportHead.map(h=>`"${h}"`).join(",") + "\n";
            exportData.forEach(r => csv += r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")+"\n");
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
            a.download = "PO_Data.csv"; a.click();
        }
    </script>
</body>
</html>
