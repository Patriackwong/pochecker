<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบค้นหา PO - คลังน้ำมัน</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 90%; max-width: 500px; text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        #error-msg { color: red; margin-top: 10px; font-size: 0.9em; }
        #result-area { margin-top: 20px; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px; }
        .row-item { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .timer { font-weight: bold; color: #d9534f; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container">
        <div id="login-section">
            <h2>เข้าสู่ระบบคลังน้ำมัน</h2>
            <p id="lock-status" class="hidden">ระบบถูกระงับชั่วคราว <span id="timer-display" class="timer"></span></p>
            <input type="password" id="access-code" placeholder="กรอกรหัสผ่าน">
            <button id="btn-login" onclick="checkLogin()">เข้าสู่ระบบ</button>
            <p id="error-msg"></p>
        </div>

        <div id="search-section" class="hidden">
            <h2>ค้นหาข้อมูล PO</h2>
            <input type="text" id="po-input" placeholder="ระบุเลข PO">
            <button onclick="searchPO()">ค้นหา</button>
            <div id="result-area"></div>
            <br>
            <button onclick="logout()" style="background-color: #6c757d;">ออกจากระบบ</button>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // วาง URL ของ Google Apps Script ที่นี่
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywu7Y1NxgCqtlEZadwI9KsSsrbRujKfiBR66d1Mt-KwWwHpDFcdWu-_VkY3Ia-OMAk_Q/exec'; 
        // ----------------------------------------------------

        let attempts = parseInt(localStorage.getItem('login_attempts')) || 0;
        let lockUntil = parseInt(localStorage.getItem('lock_until')) || 0;

        // เช็คเวลาล็อคเมื่อเปิดเว็บ
        checkLockout();

        function checkLockout() {
            const now = new Date().getTime();
            if (now < lockUntil) {
                disableLogin(lockUntil - now);
            } else {
                enableLogin();
            }
        }

        function disableLogin(remainingTime) {
            document.getElementById('access-code').disabled = true;
            document.getElementById('btn-login').disabled = true;
            document.getElementById('lock-status').classList.remove('hidden');
            
            // นับถอยหลัง
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const diff = lockUntil - now;
                
                if (diff <= 0) {
                    clearInterval(interval);
                    enableLogin();
                } else {
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    document.getElementById('timer-display').innerText = `กรุณารอ ${minutes} นาที ${seconds} วินาที`;
                }
            }, 1000);
        }

        function enableLogin() {
            localStorage.removeItem('lock_until');
            // ไม่รีเซ็ต attempts จนกว่าจะล็อกอินผ่าน หรือครบกำหนด
            if (new Date().getTime() > lockUntil) {
                 // อาจจะเลือก reset attempts หรือคงไว้ขึ้นอยู่กับ policy
            }
            document.getElementById('access-code').disabled = false;
            document.getElementById('btn-login').disabled = false;
            document.getElementById('lock-status').classList.add('hidden');
            document.getElementById('error-msg').innerText = "";
        }

        async function checkLogin() {
            const code = document.getElementById('access-code').value;
            const btn = document.getElementById('btn-login');
            
            if (!code) return;

            btn.innerText = "กำลังตรวจสอบ...";
            btn.disabled = true;

            try {
                const response = await fetch(`${SCRIPT_URL}?action=login&code=${code}`);
                const result = await response.json();

                if (result.status === 'success') {
                    // ล็อกอินสำเร็จ
                    attempts = 0;
                    localStorage.setItem('login_attempts', 0);
                    localStorage.removeItem('lock_until');
                    
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('search-section').classList.remove('hidden');
                } else {
                    // รหัสผิด
                    handleFailedLogin();
                }
            } catch (error) {
                alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
            } finally {
                btn.innerText = "เข้าสู่ระบบ";
                btn.disabled = false;
                // เช็คสถานะล็อคอีกทีเผื่อเพิ่งโดนล็อค
                if (new Date().getTime() < parseInt(localStorage.getItem('lock_until'))) {
                    btn.disabled = true;
                }
            }
        }

        function handleFailedLogin() {
            attempts++;
            localStorage.setItem('login_attempts', attempts);
            let waitTime = 0;

            if (attempts >= 10) {
                waitTime = 60 * 60 * 1000; // 1 ชั่วโมง
            } else if (attempts >= 3) {
                waitTime = 20 * 60 * 1000; // 20 นาที
            }

            if (waitTime > 0) {
                lockUntil = new Date().getTime() + waitTime;
                localStorage.setItem('lock_until', lockUntil);
                checkLockout();
                alert("คุณกรอกผิดเกินจำนวนครั้งที่กำหนด! ระบบจะระงับการใช้งานชั่วคราว");
            } else {
                alert("รหัสผิด โปรดติดต่อ ส่วนสนับสนุนคลังน้ำมัน");
                document.getElementById('error-msg').innerText = `รหัสไม่ถูกต้อง (ครั้งที่ ${attempts})`;
            }
        }

        async function searchPO() {
            const po = document.getElementById('po-input').value;
            const resultArea = document.getElementById('result-area');
            
            if(!po) return;

            resultArea.innerHTML = "กำลังค้นหา...";
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=search&po=${po}`);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    let html = "<h3>ผลการค้นหา:</h3>";
                    result.data.forEach((item, index) => {
                        html += `<div class='row-item'><strong>Col ${index+1}:</strong> ${item}</div>`;
                    });
                    resultArea.innerHTML = html;
                } else {
                    resultArea.innerHTML = "<span style='color:red'>ไม่พบข้อมูล PO นี้</span>";
                }
            } catch (error) {
                resultArea.innerHTML = "เกิดข้อผิดพลาดในการดึงข้อมูล";
            }
        }

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>
